<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echange Cartes 3SLHB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        @keyframes gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .bg-mesh {
            background: linear-gradient(135deg, #0c1e3d 0%, #1e3a5f 50%, #2e5984 100%);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glass-card-strong {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .member-card:hover {
            transform: translateX(8px) scale(1.02);
            background: rgba(135, 206, 235, 0.15);
        }
        .card-badge {
            background: linear-gradient(135deg, #87CEEB 0%, #4A90E2 100%);
        }
        .card-badge-wanted {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
        }
    </style>
</head>
<body class="bg-mesh min-h-screen p-4 md:p-8">

<div class="fixed inset-0 overflow-hidden pointer-events-none">
    <div class="absolute top-20 left-10 w-72 h-72 bg-sky-500/10 rounded-full blur-3xl"></div>
    <div class="absolute bottom-20 right-10 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-sky-400/5 rounded-full blur-3xl"></div>
</div>

<div class="max-w-7xl mx-auto relative z-10">
    <%- include('partials/navbar', { currentPage: 'home' }) %>

    <header class="text-center mb-12">
        <h1 class="text-5xl md:text-7xl font-black bg-gradient-to-r from-sky-200 via-sky-400 to-sky-200 bg-clip-text text-transparent mb-4">
            Echange CARTES
        </h1>
        <p class="text-xl text-slate-300">Album 3SLHB - Saison 2025-2026</p>
    </header>

    <!-- Barre de recherche -->
    <div class="max-w-4xl mx-auto mb-8">
        <div class="glass-card-strong rounded-2xl p-6">
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-300 mb-2">Rechercher par membre</label>
                    <div class="relative">
                        <input type="text" id="searchMember" placeholder="Nom du membre..."
                               class="w-full bg-white/10 text-white placeholder-slate-400 rounded-xl px-4 py-3 pl-10 focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all">
                        <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-300 mb-2">Rechercher par carte</label>
                    <div class="relative">
                        <input type="text" id="searchCard" placeholder="Ex: 42, I2, A4..."
                               class="w-full bg-white/10 text-white placeholder-slate-400 rounded-xl px-4 py-3 pl-10 focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all">
                        <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <div id="searchResults" class="mt-4 hidden">
                <div class="text-slate-300 text-sm font-medium mb-2">Resultats :</div>
                <div id="resultsContainer"></div>
            </div>
        </div>
    </div>

    <!-- Liste des membres -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-white mb-6 text-center">
            Membres et leurs doubles (<span id="memberCount"><%= members.length %></span>)
        </h2>

        <div id="membersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <% members.forEach(function(member) { %>
                <a href="/member/<%= member.id %>" class="member-card glass-card rounded-xl p-5 transition-all duration-300 block">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-grow min-w-0">
                            <h3 class="text-lg font-semibold text-white truncate mb-1">
                                <%= member.displayName %>
                            </h3>
                            <p class="text-sm text-slate-400">
                                <%= member.duplicates.length %> carte<%= member.duplicates.length > 1 ? 's' : '' %> en double
                                <% if (member.wanted.length > 0) { %>
                                    &middot; <%= member.wanted.length %> recherchee<%= member.wanted.length > 1 ? 's' : '' %>
                                <% } %>
                            </p>
                        </div>
                    </div>
                    <% if (member.duplicates.length > 0 || member.wanted.length > 0) { %>
                        <div class="flex flex-wrap gap-2">
                            <% member.duplicates.slice(0, 6).forEach(function(card) { %>
                                <span class="card-badge px-2 py-1 rounded text-xs font-semibold text-white">
                                    <%= card %>
                                </span>
                            <% }); %>
                            <% if (member.duplicates.length > 6) { %>
                                <span class="px-2 py-1 rounded text-xs font-semibold text-slate-400 bg-slate-700/50">
                                    +<%= member.duplicates.length - 6 %>
                                </span>
                            <% } %>
                            <% if (member.wanted.length > 0) { %>
                                <span class="px-2 py-1 rounded text-xs font-semibold text-amber-400 bg-amber-500/20">
                                    cherche <%= member.wanted.length %>
                                </span>
                            <% } %>
                        </div>
                    <% } else { %>
                        <p class="text-sm text-slate-500 italic">Aucune carte enregistree</p>
                    <% } %>
                </a>
            <% }); %>
        </div>

        <div id="noMembers" class="hidden text-center py-12">
            <p class="text-xl text-slate-400">Aucun membre trouve</p>
        </div>
    </div>
</div>

<script>
	const searchMember = document.getElementById('searchMember');
	const searchCard = document.getElementById('searchCard');
	const searchResults = document.getElementById('searchResults');
	const resultsContainer = document.getElementById('resultsContainer');
	const membersList = document.getElementById('membersList');
	const noMembers = document.getElementById('noMembers');
	const memberCards = document.querySelectorAll('.member-card');

	let searchTimeout;

	// Recherche par membre (client-side)
	searchMember.addEventListener('input', function(e) {
		const query = e.target.value.toLowerCase().trim();
		searchCard.value = '';
		searchResults.classList.add('hidden');

		let visibleCount = 0;
		memberCards.forEach(card => {
			const name = card.querySelector('h3').textContent.toLowerCase();
			if (name.includes(query)) {
				card.style.display = 'block';
				visibleCount++;
			} else {
				card.style.display = 'none';
			}
		});

		document.getElementById('memberCount').textContent = visibleCount;

		if (visibleCount === 0 && query !== '') {
			membersList.classList.add('hidden');
			noMembers.classList.remove('hidden');
		} else {
			membersList.classList.remove('hidden');
			noMembers.classList.add('hidden');
		}
	});

	// Recherche par carte (server-side)
	searchCard.addEventListener('input', function(e) {
		const query = e.target.value.trim().toUpperCase();
		searchMember.value = '';

		memberCards.forEach(card => card.style.display = 'block');
		membersList.classList.remove('hidden');
		noMembers.classList.add('hidden');
		document.getElementById('memberCount').textContent = memberCards.length;

		if (query === '') {
			searchResults.classList.add('hidden');
			return;
		}

		clearTimeout(searchTimeout);
		searchTimeout = setTimeout(async () => {
			try {
				const response = await fetch(`/api/search?type=card&query=${encodeURIComponent(query)}`);
				const data = await response.json();

				if (data.success && data.result) {
					if (data.result.members.length > 0) {
						resultsContainer.innerHTML = `
                        <div class="glass-card rounded-lg p-4">
                            <p class="text-white font-semibold mb-2">Carte ${data.result.cardNumber} possedee par :</p>
                            <div class="flex flex-wrap gap-2">
                                ${data.result.members.map(m => `
                                    <a href="/member/${m.id}" class="px-3 py-1 bg-sky-500/20 text-sky-300 rounded-lg hover:bg-sky-500/30 transition-colors">
                                        ${m.displayName}
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    `;
					} else {
						resultsContainer.innerHTML = `
                        <div class="glass-card rounded-lg p-4">
                            <p class="text-slate-400">Aucun membre ne possede la carte ${query}</p>
                        </div>
                    `;
					}
					searchResults.classList.remove('hidden');
				}
			} catch (error) {
				console.error('Search error:', error);
			}
		}, 300);
	});
</script>

</body>
</html>
